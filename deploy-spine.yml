- name: Deploy new SPINE switch
  hosts: spines
  gather_facts: no

  tasks:
  - name: Enable features
    cisco.nxos.nxos_feature:
        feature: "{{ item }}"
    loop: "{{ features }}"

  - name: Configure hostname
    cisco.nxos.nxos_hostname:
      config:
        hostname: "{{ hostname }}"

  - name: Enable overlay EVPN
    cisco.nxos.nxos_evpn_global:
      nv_overlay_evpn: true

  - name: Chagen the system mtu to 9216
    cisco.nxos.nxos_system:
      system_mtu: 9216

  - name: Configure loopback interfaces
    cisco.nxos.nxos_interfaces:
      config:
        - name: "loopback {{ item.id }}"
          enabled: true
    loop: "{{ loopbacks }}"

  - name: Configure loopback interfaces - ip address
    cisco.nxos.nxos_l3_interfaces:
      config:
        - name: "loopback {{ item.id }}"
          ipv4:
            - address: "{{ item.address }}"
    loop: "{{ loopbacks }}"

  - name: Configure underlay interfaces
    cisco.nxos.nxos_interfaces:
      config:
        - name: "Ethernet{{ item.id }}"
          enabled: true
          mode: layer3
    loop: "{{ underlay_interfaces }}"

  - name: Configure underlay interfaces - ip address
    cisco.nxos.nxos_l3_interfaces:
      config:
        - name: "Ethernet{{ item.id }}"
          ipv4:
            - address: "{{ item.address }}"
    loop: "{{ underlay_interfaces }}"

  - name: Enable OSPF
    cisco.nxos.nxos_ospfv2:
      config:
        processes:
          - process_id: "{{ ospf.id }}"
            router_id: "{{ loopbacks[0].address | ansible.utils.ipaddr('address') }}"
            default_information:
              originate:
                always: true
                
  - name: Enable OSPF over loopback interfaces
    cisco.nxos.nxos_ospf_interfaces:
        config:
          - name: "loopback {{ item.id }}"
            address_family:
              - afi: ipv4
                processes:
                  - process_id: "{{ ospf.id }}"
                    area:
                      area_id: "{{ ospf.area }}"
    loop: "{{ loopbacks }}"

  - name: Enable OSPF over underlay interfaces
    cisco.nxos.nxos_ospf_interfaces:
        config:
          - name: "Ethernet{{ item.id }}"
            address_family:
              - afi: ipv4
                processes:
                  - process_id: "{{ ospf.id }}"
                    area:
                      area_id: "{{ ospf.area }}"
    loop: "{{ underlay_interfaces }}"

  - name: Enable BGP
    cisco.nxos.nxos_bgp_global:
      config:
        as_number: "{{ bgp.asn }}"
        router_id: "{{ loopbacks[0].address | ansible.utils.ipaddr('address') }}"

  - name: Configure BGP address families
    cisco.nxos.nxos_bgp_address_family:
      config:
        as_number: "{{ bgp.asn }}"
        address_family:
          - afi: ipv4
            safi: unicast
          - afi: l2vpn
            safi: evpn
            retain:
              route_target:
                retain_all: true

  - name: Configure BGP neighbors
    cisco.nxos.nxos_bgp_global:
      config:
        as_number: "{{ bgp.asn }}"
        neighbors:
          - neighbor_address: "{{ item | ansible.utils.ipaddr('address')}}"
            remote_as: "{{ bgp.asn }}"
            update_source: "loopback {{ loopbacks[0].id }}"
    loop: "{{ groups['leafs'] | map('extract', hostvars, ['loopbacks', 0, 'address']) | list }}"

  - name: Configure BGP neighbor address families
    cisco.nxos.nxos_bgp_neighbor_address_family:
      config:
        as_number: "{{ bgp.asn }}"
        neighbors:         
          - neighbor_address: "{{ item | ansible.utils.ipaddr('address') }}"
            address_family:
              - afi: ipv4
                safi: unicast
                send_community:
                  both: true
                route_reflector_client: true
              - afi: l2vpn
                safi: evpn
                send_community:
                  both: true
                route_reflector_client: true
    loop: "{{ groups['leafs'] | map('extract', hostvars, ['loopbacks', 0, 'address']) | list }}"

  - name: Configure default route
    cisco.nxos.nxos_static_routes:
      config:
        - address_families:
          - afi: ipv4
            routes:
              - dest: "0.0.0.0/0"
                next_hops:
                  forward_router_address: "{{ default_gateway }}"

